# .github/workflows/build-netfx.yml
name: Build .NET Framework (MSBuild on Windows)

on:
  push:
    branches: [ main]
  pull_request:
    branches: [ main]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ติดตั้ง MSBuild จาก VS2022 ที่มากับ runner
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v1.3.2

      # ติดตั้ง NuGet CLI
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2.0.0

      # (ทางเลือก) Cache NuGet packages
      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            **/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      # Restore แบบโปรเจกต์ที่ใช้ packages.config (ถ้าโซลูชันใช้ PackageReference ข้ามขั้นนี้ได้)
      - name: NuGet restore
        run: nuget restore ".\Fixed_Broadband.sln"
        

      # Build ด้วย MSBuild
      - name: Build (Release | Any CPU)
        run: msbuild ".\Fixed_Broadband.sln" /m /p:Configuration=Release /p:Platform="Any CPU" /p:TreatWarningsAsErrors=false /p:WarningsAsErrors=

      # (ทางเลือก) รัน MSTest/VSTest สำหรับ .NET Framework
      # ต้องมี MSTest.TestAdapter/Framework ใน test projects อยู่แล้ว
      - name: Run tests (VSTest)
        run: |
          "$VSWherePath = & 'C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe' -latest -products * -requires Microsoft.VisualStudio.PackageGroup.TestTools.Core -property installationPath
          $VSTestPath = Join-Path $VSWherePath 'Common7\IDE\CommonExtensions\Microsoft\TestWindow\vstest.console.exe'
          & $VSTestPath (Get-ChildItem -Recurse -Filter "*test*.dll" -Path .\ -Include bin\Release\**\*test*.dll | % { $_.FullName }) --logger:"trx;LogFileName=testresults.trx"
        shell: powershell

      # เก็บผล build เป็น artifact
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: drop-Release
          path: |
            **\bin\Release\**
            !**\obj\**

