@model WBBContract.Queries.FBBWebConfigQueries.GetReportProblemsQuery
@using WBBEntity.PanelModels;
@{

    string lGridColReportDate = string.Empty;
    string lGridColInternetNo = string.Empty;
    string lGridColReportType = string.Empty;
    string lGridColDescription = string.Empty;
    string lGridColContactName = string.Empty;
    string lGridColContactEmail = string.Empty;
    string lGridColContactMobile = string.Empty;
    string lGridColSendMailStatus = string.Empty;
    string lGridColErrorMessage = string.Empty;

    string lPageCancel = string.Empty;
    string lPageSearch = string.Empty;
    string lPageExport = string.Empty;
    string lReportName = string.Empty;
    string lPageSearchPanel = string.Empty;
    string lPageDateFrom = string.Empty;
    string lPageDateTo = string.Empty;
    string cfg_calendar = string.Empty;
   
    if (ViewBag.configscreen != null)
    {
        var configscreen = (List<LovValueModel>)ViewBag.configscreen;

        lGridColReportDate = configscreen.Any(f => f.Name == "REPORT_DATE") ? configscreen.First(f => f.Name == "REPORT_DATE").LovValue2 : "";
        lGridColInternetNo = configscreen.Any(f => f.Name == "INTERNET_NO") ? configscreen.First(f => f.Name == "INTERNET_NO").LovValue2 : "";
        lGridColReportType = configscreen.Any(f => f.Name == "REPORT_TYPE") ? configscreen.First(f => f.Name == "REPORT_TYPE").LovValue2 : "";
        lGridColDescription = configscreen.Any(f => f.Name == "DESCRIPTION") ? configscreen.First(f => f.Name == "DESCRIPTION").LovValue2 : "";
        lGridColContactName = configscreen.Any(f => f.Name == "CONTACT_NAME") ? configscreen.First(f => f.Name == "CONTACT_NAME").LovValue2 : "";
        lGridColContactEmail = configscreen.Any(f => f.Name == "CONTACT_EMAIL") ? configscreen.First(f => f.Name == "CONTACT_EMAIL").LovValue2 : "";
        lGridColContactMobile = configscreen.Any(f => f.Name == "CONTACT_MOBILE") ? configscreen.First(f => f.Name == "CONTACT_MOBILE").LovValue2 : "";
        lGridColSendMailStatus = configscreen.Any(f => f.Name == "STATUS_SEND_EMAIL") ? configscreen.First(f => f.Name == "STATUS_SEND_EMAIL").LovValue2 : "";
        lGridColErrorMessage = configscreen.Any(f => f.Name == "ERROR_MESSAGE") ? configscreen.First(f => f.Name == "ERROR_MESSAGE").LovValue2 : "";

        lPageCancel = configscreen.Any(f => f.Name == "L_PAGE_CANCEL") ? configscreen.First(f => f.Name == "L_PAGE_CANCEL").LovValue2 : "";
        lPageSearch = configscreen.Any(f => f.Name == "L_PAGE_SEARCH") ? configscreen.First(f => f.Name == "L_PAGE_SEARCH").LovValue2 : "";
        lPageExport = configscreen.Any(f => f.Name == "L_PAGE_EXPORT") ? configscreen.First(f => f.Name == "L_PAGE_EXPORT").LovValue2 : "";
        lReportName = configscreen.Any(f => f.Name == "L_REPORT_NAME") ? configscreen.First(f => f.Name == "L_REPORT_NAME").LovValue2 : "";
        lPageSearchPanel = configscreen.Any(f => f.Name == "L_PAGE_SEARCH_PANEL") ? configscreen.First(f => f.Name == "L_PAGE_SEARCH_PANEL").LovValue2 : "";
        lPageDateFrom = configscreen.Any(f => f.Name == "L_PAGE_DATE_FROM") ? configscreen.First(f => f.Name == "L_PAGE_DATE_FROM").LovValue2 : "";
        lPageDateTo = configscreen.Any(f => f.Name == "L_PAGE_DATE_TO") ? configscreen.First(f => f.Name == "L_PAGE_DATE_TO").LovValue2 : "";
        cfg_calendar = configscreen.Any(f => f.Name == "CFG_DATE_CALENDAR") ? configscreen.First(f => f.Name == "CFG_DATE_CALENDAR").LovValue2 : "";
    }   
    
}
<html>
    <style>
        .rowFormat {
            margin-bottom: 15px;
        }
    </style>
    <head>
        <meta name="viewport" content="width=device-width" />
        <title>Index</title>
    </head>
    <body>
        <div class="page-header i-header-fit">
            <div class="row">
                <div class="col-sm-12 col-md-12">
                    <h3 style="margin-top: 0">@lReportName</h3>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12 col-md-12">
                <div class="panel panel-success">            
                    <div class="panel-heading">
                        <h3 class="panel-title">
                            <span>@lPageSearchPanel</span>
                            <a data-toggle="collapse" class="pull-right" href="#SearchPanel" onclick="onPanelToggle(this);" id="SearchPanelHeader"><i class="fa fa-chevron-circle-down fa-lg" id="SearchPanelHeaderArrow"></i></a>
                        </h3>
                    </div>
                    <div id="SearchPanel" class="panel-collapse collapse in">
                        <div class="panel-body" style="min-height: 135px;">
                            <div class="row">
                                <div class="col-sm-6 col-md-6 rowFormat">
                                    <label>@lGridColReportType</label>
                                    <div class="i-fg-data-entry">
                                        @(Html.Kendo().DropDownList()
                                              .Name("ddlProblemType")
                                              .DataTextField("DISPLAY_VAL")
                                              .DataValueField("LOV_NAME")
                                              .HtmlAttributes(new { @class = "form-control i-form-control-extend" })
                                              .DataSource(source => source.Read(read => read.Action("GetProblemType", "MasterData", new { type = "PROBLEM_TYPE" })))
                                              )
                                    </div>
                                </div>
                            </div> 
                            <div id="row1" class="row">
                                <div class="col-sm-6 col-md-6 rowFormat">
                                    <label>@lPageDateFrom</label>
                                    <div class="i-fg-data-entry">
                                        @(Html.Kendo().DatePicker().Name("dtpDateFrom")
                                              .HtmlAttributes(new { @class = "form-control i-form-control-extend" })
                                              .ParseFormats(new List<string> { "dd/MM/yyyy" })
                                              .Format("dd/MM/yyyy")
                                              .Min(new DateTime(1900,1,1))
                                              .Max(new DateTime(2099,12,31))
                                              .Events(e => e.Change("ChangdtpDateFrom")))
                                    </div>
                                    <div class="i-fg-data-entry-validation" id="validatefor-dtpDateFrom"></div>
                                    <span class="k-invalid-msg" data-for="PickupDate"></span>
                                </div>
                                <div class="col-sm-6 col-md-6 rowFormat">
                                    <label>@lPageDateTo</label>
                                    <div class="i-fg-data-entry">
                                        @(Html.Kendo().DatePicker().Name("dtpDateTo")
                                              .HtmlAttributes(new { @class = "form-control i-form-control-extend" })
                                              .Format("dd/MM/yyyy")
                                              .Min(new DateTime(1900,1,1))
                                              .Max(new DateTime(2099,12,31))
                                              .ParseFormats(new List<string> { "dd/MM/yyyy" })
                                              .Events(e => e.Change("ChangdtpDateTo")))
                                    </div>
                                    <div class="i-fg-data-entry-validation" id="validatefor-dtpDateTo"></div>
                                </div>
                            </div> @*end row1*@
                            <div id="row2" class="row i-gap-top-1">
                                <div class="col-sm-6 col-md-6">                                      
                                </div>
                                <div class="col-sm-6 col-md-6 i-text-align-right">          
                                    <a class="btn btn-default" onclick="_Clear();"><i class="fa fa-ban fa-lg"></i>&nbsp;&nbsp;@lPageCancel</a>
                                    <a class="btn btn-info" onclick="_Search();"><i class="fa fa-search fa-lg"></i>&nbsp;&nbsp;@lPageSearch</a>            
                                </div>                                            
                            </div>@*end row2*@
              
                        </div> @*end SearchPanel*@
                    </div>  

                </div>
            </div>
        </div>
        <div id="gridresult" class="row">
            <div class="col-sm-12 col-md-12 " >
                @(Html.Kendo().Grid<WBBEntity.PanelModels.FBBWebConfigModels.ReportProblemsModel>()
                      .Name("gridReportProblemRpt")
                      .Columns(columns =>
                      {
                          columns.Bound(p => p.CREATED_DATE).Title(lGridColReportDate).HtmlAttributes(new { style = "text-align:center;" }).Width(140);
                          columns.Bound(p => p.CUST_INTERNET_NUM).Title(lGridColInternetNo).HtmlAttributes(new { style = "text-align:center;" }).Width(120);
                          columns.Bound(p => p.PROBLEM_TYPE_DES).Title(lGridColReportType).HtmlAttributes(new { style = "text-align:center;" }).Width(190);
                          columns.Bound(p => p.PROBLEM_DETAILS).Title(lGridColDescription).HtmlAttributes(new { style = "text-align:left;" }).Width(300);
                          columns.Bound(p => p.CONTACT_INFO).Title(lGridColContactName).HtmlAttributes(new { style = "text-align:left;" }).Width(170);
                          columns.Bound(p => p.CONTACT_EMAIL).Title(lGridColContactEmail).HtmlAttributes(new { style = "text-align:left;" }).Width(200);
                          columns.Bound(p => p.CONTACT_NUM).Title(lGridColContactMobile).HtmlAttributes(new { style = "text-align:left;" }).Width(150);
                          columns.Bound(p => p.SEND_EMAIL_STATUS).Title(lGridColSendMailStatus).HtmlAttributes(new { style = "text-align:center;" }).Width(150);
                      })
                      .Scrollable(scrollable => scrollable.Height("auto"))    
                      .ToolBar(toolbar => toolbar.Template("" +
                                                           //disabled='disabled'
                                                           "<div class='pull-right'><a onclick='_ExportToExcel()' id='btnExport'  class='btn btn-default'><i class='fa fa-reply fa-lg'></i>&nbsp; "+ lPageExport +"</a>&nbsp;</div>"         
                          ))
                      //.ToolBar(toolBar =>
                      //    {
                      //        toolBar.Custom().Name("NewCoverExcel").Text("<i class='fa fa-file-excel-o'></i> New Coverage").HtmlAttributes(new { onclick = "goimortexcel();return false;" });
                      //        toolBar.Custom().Name("NewCoverNormal").Text("<i class='fa fa-plus-circle fa-lg'></i> New Coverage").HtmlAttributes(new { onclick = "goaddnew();return false;" });
                      //        toolBar.Custom().Text("<i class='fa fa-reply'></i> Export to Excel").HtmlAttributes(new { onclick = "_ExportToExcel();return false;" });                               
                      //    }
                      //    )
                      .Pageable(pageable => pageable                    
                          //.PageSizes(true)
                          .Numeric(true)   
                          .PageSizes(new int[] {20, 50, 100})   
                      )
                      .Sortable()   
                      .AutoBind(false) 
                      //.Filterable()                 
                      .Resizable(resize => resize.Columns(true))   
                      .DataSource(dataSource => dataSource
                          .Ajax()
                          .PageSize(20)                 
                          //.Sort(sort => sort.Add(p => p.Item_no).Ascending())   
                          .Read(read => read.Action("ReportRead", "ReportProblem").Data("bindingValue"))
                          )
                      .Events(e => e.DataBound("onGridDataBound"))
                      
                      )
            </div>                
        </div>         
        
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="modal001_label">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header" style="border-bottom: none;">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    </div>
                    <div class="modal-body">
                        <div class="add-border-rounded-green">
                            <p class="clearfix"></p>
                            <h5 id="modal001txt" class="text-center">
                                <span id="LastPopupMessage"></span>
                            </h5>
                            <p class="clearfix"></p>
                            <div class="col-md-12 text-center">
                                <p class="clearfix"></p>
                                <button type="button" id="btnBack" class="btn btn-default" data-dismiss="modal" >&nbsp; Back &nbsp; </button>
                                <button type="button" id="btnReset" class="btn btn-default" data-dismiss="modal" >&nbsp; Reset &nbsp; </button>
                                <button type="button" id="btnOk" class="btn btn-success" data-dismiss="modal" >&nbsp; OK &nbsp; </button>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="border-top: none;">
                    </div>
                </div>
            </div>
        </div>
        

    </body>

    <script>
        $(document).ready(function () {
            //debugger        
            $('#btnExport').attr("disabled", true);
            $("#dtpDateFrom").data("kendoDatePicker").value("");
            $("#dtpDateTo").data("kendoDatePicker").value("");
            $("#ddlProblemType").data("kendoDropDownList").select(0);
        });

        function post(path, params, method) {

            method = method || "post"; // Set method to post by default if not specified.

            // The rest of this code assumes you are not using a library.
            // It can be made less wordy if you use one.
            var form = document.createElement("form");
            form.setAttribute("method", method);
            form.setAttribute("action", path);

            for (var key in params) {
                if (params.hasOwnProperty(key)) {
                    var hiddenField = document.createElement("input");
                    hiddenField.setAttribute("type", "hidden");
                    hiddenField.setAttribute("name", key);
                    hiddenField.setAttribute("value", params[key]);

                    form.appendChild(hiddenField);
                }
            }

            document.body.appendChild(form);
            form.submit();
        }

        function _ExportToExcel() {
            var model = new defaultDataExport();

            window.open("/ReportProblem/Export?dataS=" + JSON.stringify(model) + "");
        }

        function onGridDataBound() {
            Loading(0);
            if (this.dataSource.view().length == 0) {
                
                //insert empty row

                var colspan = this.thead.find("th").length;
                //alert(colspan)
                var emptyRow = "<tr><td colspan='" + colspan + "'></td></tr>";
                this.tbody.html(emptyRow);

                //workarounds for IE lt 9
                //this.table.width(800);
                //$(".k-grid-content").width(2 * kendo.support.scrollbar());
                $(".k-grid-content").height(3 * kendo.support.scrollbar());
                $('#btnExport').attr("disabled", true);
            }
            else {
                $(".k-grid-content").height("auto");
                $('#btnExport').attr("disabled", false);
                //this.dataSource.total = 100;
            }
        }

        function _Search() {
            var model = defaultData();
            var chk = ValidationDateValue();
            if (chk) {
                Loading();
                var grid = $("#gridReportProblemRpt").data("kendoGrid");
                grid.dataSource.page(1);
                //$.ajax({
                //    url: '/ReportProblem/ReportSearch',
                //    data: { dataS: JSON.stringify(model) },
                //    dataType: "json",
                //    type: 'POST',
                //    success: function (response) {

                //        if (response) {

                //            if (response.item == "0") {
                //                $('#btnExport').attr("disabled", true);
                //            }
                //            else {
                //                $('#btnExport').attr("disabled", false);
                //            }

                //        }
                //    },
                //    failure: function (msg) {
                //    }
                //});
            }
        }

        function ValidationDateValue() {

            var chk = ValidationProcessing("dateselect");

            if (chk) //check blank value
            {
                if ($.trim($("#dtpDateFrom").val()) == '') {
                    $("#validatefor-" + "dtpDateFrom").html(ValidationIcon() + "This field is required.");
                    chk = false;
                }
                else {
                    $("#validatefor-" + "dtpDateFrom").html("");
                }

                if ($.trim($("#dtpDateTo").val()) == '') {
                    $("#validatefor-" + "dtpDateTo").html(ValidationIcon() + "This field is required.");
                    chk = false;
                }
                else {
                    $("#validatefor-" + "dtpDateTo").html("");
                }
            }

            if (chk) //check format
            {
                if (!kendo.parseDate($("#dtpDateFrom").val(), "dd/MM/yyyy")) {
                    if ($("#dtpDateFrom").val() != "") {
                        $("#validatefor-" + "dtpDateFrom").html(ValidationIcon() + "This field is not correct format.");
                        chk = false;
                    }
                }
                else {
                    $("#validatefor-" + "dtpDateFrom").html("");
                }

                if (!kendo.parseDate($("#dtpDateTo").val(), "dd/MM/yyyy")) {
                    if ($("#dtpDateTo").val() != "") {
                        $("#validatefor-" + "dtpDateTo").html(ValidationIcon() + "This field is not correct format.");
                        chk = false;
                    }
                }
                else {
                    $("#validatefor-" + "dtpDateTo").html("");
                }
            }

            if (chk) //check Date From must be earlier than Date To
            {
                var startPicker = new Date(kendo.parseDate($("#dtpDateFrom").val(), "mm/dd/yyyy"));
                var endPicker = new Date(kendo.parseDate($("#dtpDateTo").val(), "mm/dd/yyyy"));

                if (startPicker > endPicker) {
                    if ($("#dtpDateFrom").val() != "") {
                        $("#validatefor-" + "dtpDateFrom").html(ValidationIcon() + "Date From must be earlier than Date To.");
                        chk = false;
                    }
                    else {
                        $("#validatefor-" + "dtpDateFrom").html("");
                    }
                }
            }
            return chk;
        }

        var ReportModel = function () {
            dateFrom: "";
            dateTo: "";
            sortBy: "";
            sortColumn: "";
            sortColumnName: "";
            problemType: "";
            problemTypeName: "";
        }

        function bindingValue() {
            var model = defaultData();
            return {
                dataS: JSON.stringify(model)
            };
        }

        function defaultData() {
            var searchResult = new ReportModel();
            searchResult.dateFrom = kendo.parseDate($("#dtpDateFrom").val(), "dd/MM/yyyy");
            searchResult.dateTo = kendo.parseDate($("#dtpDateTo").val(), "dd/MM/yyyy");
            searchResult.problemType = $("#ddlProblemType").val();
            searchResult.problemTypeName = $("#ddlProblemType").data("kendoDropDownList").text();

            return searchResult;
        }


        function defaultDataExport() {
            var sortColumn = '';
            var searchResult = new ReportModel();
            searchResult.dateFrom = kendo.parseDate($("#dtpDateFrom").val(), "dd/MM/yyyy");
            searchResult.dateTo = kendo.parseDate($("#dtpDateTo").val(), "dd/MM/yyyy");
            searchResult.problemType = $("#ddlProblemType").val();
            searchResult.problemTypeName = $("#ddlProblemType").data("kendoDropDownList").text();

            var grid = $("#gridReportProblemRpt").data("kendoGrid");
            var dataSource = grid.dataSource;
            var kendoSort = dataSource.sort();
            if (kendoSort != null && kendoSort != "undefined" && kendoSort[0] != null) {
                searchResult.sortBy = kendoSort[0].dir == null ? "" : kendoSort[0].dir;
                sortColumn = kendoSort[0].field == null ? "" : kendoSort[0].field;
                searchResult.sortColumn = sortColumn;

            }
            var column = grid.columns;
            if (column != null && sortColumn != '') {
                var result = $.grep(grid.columns, function (e) { return e.field == sortColumn; });
                searchResult.sortColumnName = result != null ? result[0].title : '';
            }

            return searchResult;
        }

        function _Clear() {
            $("#dtpDateFrom").data("kendoDatePicker").value("");
            $("#dtpDateTo").data("kendoDatePicker").value("");
            $("#ddlProblemType").data("kendoDropDownList").select(0);
            //reset min, max.
            $("#dtpDateFrom").data("kendoDatePicker").max(new Date(2099, 11, 31, 0, 0, 0, 0));
            $("#dtpDateTo").data("kendoDatePicker").min(new Date(1900, 0, 1, 0, 0, 0, 0));

            $('#btnExport').attr("disabled", true);
            $("#gridReportProblemRpt").data("kendoGrid").dataSource.data([]);

            $("#validatefor-dtpDateTo").html("");
            $("#validatefor-dtpDateFrom").html("");
        }

        function ChangdtpDateFrom() {

            var endPicker = $("#dtpDateTo").data("kendoDatePicker"),
                startDate = this.value();

            if (startDate) {
                startDate = new Date(startDate);
                startDate.setDate(startDate.getDate());
                endPicker.min(startDate);

                var maxDate = new Date(startDate);
                maxDate.setDate(maxDate.getDate() + parseInt('@cfg_calendar'));
                endPicker.max(maxDate);
            }

        }


        function ChangdtpDateTo() {
            var startPicker = $("#dtpDateFrom").data("kendoDatePicker"),
                endDate = this.value();

            if (endDate) {
                endDate = new Date(endDate);
                endDate.setDate(endDate.getDate());
                startPicker.max(endDate);

                var minDate = new Date(endDate);
                minDate.setDate(minDate.getDate() - parseInt('@cfg_calendar'));
                startPicker.min(minDate);

            }

        }

    </script>
</html>